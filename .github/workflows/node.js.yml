name: CI/CD Pipeline - React Native + Expo

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    name: Pruebas Unitarias
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]

    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
    
    - name: Run tests
      run: npm test
    
    - name: Upload coverage
      if: matrix.node-version == '20.x'
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage/lcov.info
        fail_ci_if_error: false

  pruebas-integracion:
    name: Pruebas de Integraci√≥n
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
      
      - name: Instalar dependencias
        run: npm ci --legacy-peer-deps
      
      - name: Ejecutar pruebas de integraci√≥n
        run: npm run test:integration

  build-apk:
    name: Build APK
    runs-on: ubuntu-latest
    needs: [build, pruebas-integracion]
    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci --legacy-peer-deps

      - name: Configurar Expo y EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Generar APK con EAS Build
        run: |
          echo "üöÄ Iniciando build de APK..."
          eas build --platform android --profile preview --non-interactive --no-wait

      - name: Obtener √∫ltima build
        id: get-build
        run: |
          echo "‚è≥ Esperando 10 segundos para que la build se registre..."
          sleep 10
          echo "üì¶ Obteniendo informaci√≥n de la √∫ltima build..."
          BUILD_INFO=$(eas build:list --platform android --limit 1 --json --non-interactive)
          BUILD_ID=$(echo "$BUILD_INFO" | jq -r '.[0].id')
          echo "build-id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "‚úÖ Build ID: $BUILD_ID"

      - name: Esperar a que la build termine
        run: |
          echo "‚è≥ Esperando a que la build termine (m√°ximo 30 minutos)..."
          BUILD_ID="${{ steps.get-build.outputs.build-id }}"
          
          for i in {1..60}; do
            BUILD_STATUS=$(eas build:view "$BUILD_ID" --json 2>/dev/null || echo '{"status":"pending"}')
            STATUS=$(echo "$BUILD_STATUS" | jq -r '.status')
            echo "Estado actual: $STATUS (intento $i/60)"
            
            if [ "$STATUS" = "finished" ]; then
              echo "‚úÖ Build completada exitosamente"
              exit 0
            elif [ "$STATUS" = "errored" ] || [ "$STATUS" = "canceled" ]; then
              echo "‚ùå Build fall√≥ con estado: $STATUS"
              echo "Detalles del error:"
              echo "$BUILD_STATUS" | jq -r '.error // "No hay detalles adicionales"'
              exit 1
            fi
            
            sleep 30
          done
          
          echo "‚ö†Ô∏è Timeout: La build tard√≥ m√°s de 30 minutos"
          exit 1

      - name: Descargar APK
        run: |
          echo "üì• Descargando APK..."
          BUILD_ID="${{ steps.get-build.outputs.build-id }}"
          
          BUILD_DETAILS=$(eas build:view "$BUILD_ID" --json)
          ARTIFACT_URL=$(echo "$BUILD_DETAILS" | jq -r '.artifacts.buildUrl // empty')
          
          if [ -z "$ARTIFACT_URL" ] || [ "$ARTIFACT_URL" = "null" ]; then
            echo "‚ùå No se encontr√≥ URL de descarga del APK"
            echo "Detalles de la build:"
            echo "$BUILD_DETAILS" | jq '.'
            exit 1
          fi
          
          echo "üìç URL encontrada: $ARTIFACT_URL"
          curl -L -o app-release.apk "$ARTIFACT_URL"
          echo "‚úÖ APK descargado correctamente"

      - name: Verificar APK
        run: |
          if [ -f app-release.apk ]; then
            SIZE=$(ls -lh app-release.apk | awk '{print $5}')
            echo "‚úÖ APK generado exitosamente"
            echo "üìä Tama√±o: $SIZE"
          else
            echo "‚ùå Error: APK no encontrado"
            exit 1
          fi

      - name: Subir APK como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: RehabSoft-Android
          path: app-release.apk
          retention-days: 30

  deploy:
    name: Deploy a Expo
    runs-on: ubuntu-latest
    needs: build-apk
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4
      
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
      
      - name: Instalar dependencias
        run: npm ci --legacy-peer-deps
      
      - name: Configurar Expo y EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      
      - name: Publicar actualizaci√≥n en Expo
        run: |
          echo "üöÄ Publicando actualizaci√≥n en Expo..."
          echo "üì± Plataforma: Android"
          echo "üåø Branch: production"
          eas update --branch production --message "Deploy desde GitHub Actions - $(date '+%Y-%m-%d %H:%M:%S')" --platform android --non-interactive
          echo "‚úÖ Deploy completado exitosamente"