name: CI/CD Pipeline - React Native + Expo

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]

jobs:
  pruebas-unitarias:
    name: Pruebas Unitarias
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: ''
      - name: Instalar dependencias
        run: npm ci --prefer-offline --no-audit
      - run: npm run test:ci

  pruebas-integracion:
    name: Pruebas de Integraci√≥n
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: ''
      - name: Instalar dependencias
        run: npm ci --prefer-offline --no-audit
      - run: npm run test:integration

  build:
    name: Build APK
    runs-on: ubuntu-latest
    needs: [pruebas-unitarias, pruebas-integracion]
    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: ''

      - name: Instalar dependencias
        run: npm ci --prefer-offline --no-audit

      - name: Configurar Expo y EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Generar APK con EAS Build
        run: |
          echo "üöÄ Iniciando build de APK..."
          eas build --platform android --profile preview --non-interactive

      - name: Obtener √∫ltima build
        id: get-build
        run: |
          echo "üì¶ Obteniendo informaci√≥n de la √∫ltima build..."
          BUILD_INFO=$(eas build:list --platform android --limit 1 --json --non-interactive)
          BUILD_ID=$(echo "$BUILD_INFO" | jq -r '.[0].id')
          echo "build-id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "‚úÖ Build ID: $BUILD_ID"

      - name: Esperar a que la build termine
        run: |
          echo "‚è≥ Esperando a que la build termine..."
          BUILD_ID="${{ steps.get-build.outputs.build-id }}"
          
          for i in {1..60}; do
            STATUS=$(eas build:view "$BUILD_ID" --json | jq -r '.status')
            echo "Estado actual: $STATUS (intento $i/60)"
            
            if [ "$STATUS" = "finished" ]; then
              echo "‚úÖ Build completada exitosamente"
              break
            elif [ "$STATUS" = "errored" ] || [ "$STATUS" = "canceled" ]; then
              echo "‚ùå Build fall√≥ con estado: $STATUS"
              exit 1
            fi
            
            sleep 30
          done

      - name: Descargar APK
        run: |
          echo "üì• Descargando APK..."
          BUILD_ID="${{ steps.get-build.outputs.build-id }}"
          ARTIFACT_URL=$(eas build:view "$BUILD_ID" --json | jq -r '.artifacts.buildUrl')
          
          if [ "$ARTIFACT_URL" != "null" ] && [ -n "$ARTIFACT_URL" ]; then
            echo "URL encontrada: $ARTIFACT_URL"
            curl -L -o app-release.apk "$ARTIFACT_URL"
            echo "‚úÖ APK descargado correctamente"
          else
            echo "‚ùå No se encontr√≥ URL de descarga"
            exit 1
          fi

      - name: Verificar APK
        run: |
          if [ -f app-release.apk ]; then
            SIZE=$(ls -lh app-release.apk | awk '{print $5}')
            echo "‚úÖ APK generado exitosamente"
            echo "üìä Tama√±o: $SIZE"
          else
            echo "‚ùå Error: APK no encontrado"
            exit 1
          fi

      - name: Subir APK como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: RehabSoft-Android
          path: app-release.apk
          retention-days: 30

  deploy:
    name: Deploy a Expo
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4
      
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: ''
      
      - name: Instalar dependencias
        run: npm ci --prefer-offline --no-audit
      
      - name: Configurar Expo y EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      
      - name: Publicar actualizaci√≥n en Expo
        run: |
          echo "Publicando actualizaci√≥n en Expo..."
          echo "Plataforma: Android"
          echo "Branch: production"
          eas update --branch production --message "Deploy desde GitHub Actions - $(date '+%Y-%m-%d %H:%M:%S')" --platform android --non-interactive
          echo "‚úÖ Deploy completado exitosamente"